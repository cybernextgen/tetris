!function(){"use strict";function e(e,t){void 0===t&&(t={});var s=t.insertAt;if(e&&"undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===s&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}e(":root{--background-body:#202b38;--background:#161f27;--background-alt:#1a242f;--selection:#1c76c5;--text-main:#dbdbdb;--text-bright:#fff;--text-muted:#a9b1ba;--links:#41adff;--focus:#0096bfab;--border:#526980;--code:#ffbe85;--animation-duration:0.1s;--button-hover:#324759;--scrollbar-thumb:var(--button-hover);--scrollbar-thumb-hover:#415c73;--form-placeholder:#a9a9a9;--form-text:#fff;--variable:#d941e2;--highlight:#efdb43;--select-arrow:url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' height='62.5' width='116.9' fill='%23efefef'%3E%3Cpath d='M115.3 1.6c-1.6-1.6-4.2-1.6-5.8 0l-51 51.1L7.4 1.6C5.8 0 3.2 0 1.6 1.6 0 3.2 0 5.8 1.6 7.4l53.9 53.9c.8.8 1.8 1.2 2.9 1.2 1 0 2.1-.4 2.9-1.2l53.9-53.9c1.7-1.6 1.7-4.2.1-5.8Z'/%3E%3C/svg%3E\")}html{scrollbar-color:#324759 #202b38;scrollbar-color:var(--scrollbar-thumb) var(--background-body);scrollbar-width:thin}body{word-wrap:break-word;background:#202b38;background:var(--background-body);color:#dbdbdb;color:var(--text-main);font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,Segoe UI Emoji,Apple Color Emoji,Noto Color Emoji,sans-serif;line-height:1.4;margin:20px auto;max-width:800px;padding:0 10px;text-rendering:optimizeLegibility}button,input{transition:background-color .1s linear,border-color .1s linear,color .1s linear,box-shadow .1s linear,transform .1s ease;transition:background-color var(--animation-duration) linear,border-color var(--animation-duration) linear,color var(--animation-duration) linear,box-shadow var(--animation-duration) linear,transform var(--animation-duration) ease}h1{font-size:2.2em;margin-top:0}h1,h2,h3,h4,h5,h6{margin-bottom:12px;margin-top:24px}h1,h2{color:#fff;color:var(--text-bright)}b,h1,h2,h3,h4,h5,h6,strong,th{font-weight:600}button,input[type=button],input[type=checkbox],input[type=radio],input[type=range],input[type=submit],select{cursor:pointer}input:not([type=checkbox]):not([type=radio]),select{display:block}button,input,select{background-color:#161f27;background-color:var(--background);border:none;color:#fff;color:var(--form-text);font-family:inherit;font-size:inherit;margin-bottom:6px;margin-right:6px;outline:none;padding:10px}input[type=checkbox],input[type=radio]{height:1em;width:1em}input[type=radio]{border-radius:100%}input{vertical-align:top}label{display:inline-block;margin-bottom:4px;vertical-align:middle}button,input:not([type=checkbox]):not([type=radio]),input[type=range],select,textarea{-webkit-appearance:none}select{background:#161f27 url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' height='62.5' width='116.9' fill='%23efefef'%3E%3Cpath d='M115.3 1.6c-1.6-1.6-4.2-1.6-5.8 0l-51 51.1L7.4 1.6C5.8 0 3.2 0 1.6 1.6 0 3.2 0 5.8 1.6 7.4l53.9 53.9c.8.8 1.8 1.2 2.9 1.2 1 0 2.1-.4 2.9-1.2l53.9-53.9c1.7-1.6 1.7-4.2.1-5.8Z'/%3E%3C/svg%3E\") calc(100% - 12px) 50% /12px no-repeat;background:var(--background) var(--select-arrow) calc(100% - 12px) 50% /12px no-repeat;padding-right:35px}select::-ms-expand{display:none}select[multiple]{background-image:none;overflow-y:auto;padding-right:10px}button,input[type=button],input[type=submit]{padding-left:30px;padding-right:30px}button:hover,input[type=button]:hover,input[type=submit]:hover{background:#324759;background:var(--button-hover)}button:focus,input:focus,select:focus{box-shadow:0 0 0 2px #0096bfab;box-shadow:0 0 0 2px var(--focus)}button:active,input[type=button]:active,input[type=checkbox]:active,input[type=radio]:active,input[type=range]:active,input[type=submit]:active{transform:translateY(2px)}button:disabled,input:disabled,select:disabled,textarea:disabled{cursor:not-allowed;opacity:.5}::-moz-placeholder{color:#a9a9a9;color:var(--form-placeholder)}:-ms-input-placeholder{color:#a9a9a9;color:var(--form-placeholder)}::-ms-input-placeholder{color:#a9a9a9;color:var(--form-placeholder)}::placeholder{color:#a9a9a9;color:var(--form-placeholder)}::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-track{background:#161f27;background:var(--background);border-radius:6px}::-webkit-scrollbar-thumb{background:#324759;background:var(--scrollbar-thumb);border-radius:6px}::-webkit-scrollbar-thumb:hover{background:#415c73;background:var(--scrollbar-thumb-hover)}::-moz-selection{background-color:#1c76c5;background-color:var(--selection);color:#fff;color:var(--text-bright)}::selection{background-color:#1c76c5;background-color:var(--selection);color:#fff;color:var(--text-bright)}footer{border-top:1px solid #526980;border-top:1px solid var(--border);color:#a9b1ba;color:var(--text-muted);padding-top:10px}body>footer{margin-top:40px}");e("body{font-family:Menlo,Consolas,Ubuntu Mono,Roboto Mono,DejaVu Sans Mono,monospace;font-size:1em;overflow-y:hidden}h1{font-size:1.5em}.settings-page{height:calc(100vh - 40px);text-align:center}.settings-form{height:100px}.settings-form__game-mode-select{text-align:center;width:100%}.settings-form__submit-button{width:100%}.figures-preview{height:calc(100% - 155px);text-align:center}.figures-preview__canvas{height:100%;width:100%}.game-page{display:flex;height:calc(100vh - 40px)}.game-field{height:100%;padding-right:5%;width:75%}.game-field__canvas{height:100%;width:100%}.game-sidebar{height:100%;width:25%}.game-sidebar__next-figure__canvas{height:20%;width:100%}.score-page__restart__button{margin-top:24px}");class t{static instance;GAME_FIELD_BACKGROUND_COLOR;FIGURE_COLORS;GAME_MODES;GAME_FIELD_HEIGHT_IN_CELLS;GAME_FIELD_WIDTH_IN_CELLS;EFFECT_COLOR;TETRIS_EFFECT_COLOR;LEVELS;constructor(){if(t.instance)throw new Error("Use SettingsLoader.getSettings()");this.GAME_FIELD_BACKGROUND_COLOR="161f27",this.FIGURE_COLORS=[this.GAME_FIELD_BACKGROUND_COLOR,"FFD498","047C51","FE5825","700414","DF3D2E","FEFEFE","668BC4","335495"],this.GAME_MODES={EASY:"Easy mode",MEDIUM:"Medium mode",HARD:"Hard mode"},this.GAME_FIELD_HEIGHT_IN_CELLS=20,this.GAME_FIELD_WIDTH_IN_CELLS=10,this.EFFECT_COLOR="ffffff",this.TETRIS_EFFECT_COLOR="ff0000",this.LEVELS={0:770,15:730,30:680,45:620,60:550,75:470,90:380,100:280,110:160,120:100}}readSettingsFromJson(e){const t=new XMLHttpRequest;if(t.open("GET",e,!1),t.send(),200==t.status&&4==t.readyState)return JSON.parse(t.responseText)}static getSettings(){return t.instance=t.instance||new t,t.instance}}class s extends Error{}class i{matrix;rowsCount;colsCount;pivotPoint;constructor(...e){1===e.length?(this.matrix=e[0],this.rowsCount=this.matrix.length,this.rowsCount>0?this.colsCount=this.matrix[0].length:this.colsCount=0):2===e.length&&(this.colsCount=e[0],this.rowsCount=e[1],this.clear())}clear(){this.matrix=[];for(let e=0;e<this.rowsCount;e++){const e=[];e.length=this.colsCount,e.fill(0),this.matrix.push(e)}}fillWithColorIndex(e){for(let t=0;t<this.rowsCount;t++)for(let s=0;s<this.colsCount;s++)0!==this.matrix[t][s]&&(this.matrix[t][s]=e)}static copyMatrix(e){const t=[];for(let s of e)t.push([...s]);return t}mergeWithCells(e,t=0,r=0,n=!0){if(n&&(t+e.colsCount-1>=this.colsCount||r+e.rowsCount-1>=this.rowsCount||r<0||t<0))throw new RangeError("Cells goes beyond the borders!");const o=i.copyMatrix(this.matrix);let l,a;for(let i=0;i<e.rowsCount;i++){a=r+i;for(let r=0;r<e.colsCount;r++){if(l=t+r,a<0)continue;const h=e.getCell(r,i);if(n&&h&&0!==o[a][l])throw new s("Cells collide with others cells!");l<0||(o[a][l]=o[a][l]||h)}}return new i(o)}getCell(e,t){return this.matrix[t][e]}setCell(e,t,s){this.matrix[t][e]=s}getCopy(){return new i(i.copyMatrix(this.matrix))}removeRows(e){let t=i.copyMatrix(this.matrix);for(let s of e){t=i.copyMatrix(t),t.splice(s,1);const e=[];e.length=this.colsCount,e.fill(0),t.splice(0,0,e)}return new i(t)}rotateCounterClockwise(){return this.rotate(!1)}rotateClockwise(){return this.rotate()}rotate(e=!0){const t=[];for(let e=0;e<this.colsCount;e++){const e=[];e.length=this.rowsCount,t.push(e)}for(let s=0;s<this.rowsCount;s++)for(let i=0;i<this.colsCount;i++){let r=0,n=0;e?(r=this.rowsCount-s-1,n=i):(r=s,n=this.colsCount-i-1),t[n][r]=this.matrix[s][i]}return new i(t)}}class r{x;y;constructor(e,t){this.x=e,this.y=t}}class n{canvasSelector;keepAspectRatio;renderActualBounds;settings;canvas;canvas2DContext;cellWidthInPixels;cellHeightInPixels;cellUnitsCount=6;cellUnitWidthInPixels;cellUnitHeightInPixels;canvasWidthInPixels;canvasHeightInPixels;xOffset=0;yOffset=0;colsCountInternal;rowsCountInternal;cells=new i(0,0);constructor(e,s=!1,i=!1){if(this.canvasSelector=e,this.keepAspectRatio=s,this.renderActualBounds=i,this.canvas=document.querySelector(e),null===this.canvas)throw new Error(`Canvas with selector ${e} not present in document!`);this.canvas2DContext=this.canvas.getContext("2d"),window.addEventListener("resize",this.debounce((()=>{this.calculateDimensions()}))),this.settings=t.getSettings()}debounce(e,t=100){let s;return function(i){s&&clearTimeout(s),s=setTimeout(e,t,i)}}calculateDimensions(){const e=this.canvas.clientWidth,t=this.canvas.clientHeight;if(this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t),this.canvasWidthInPixels=e,this.canvasHeightInPixels=t,this.keepAspectRatio){const e=Math.floor(this.canvasWidthInPixels/this.colsCountInternal),t=Math.floor(this.canvasHeightInPixels/this.rowsCountInternal);let s=e;e>t&&(s=t),this.cellHeightInPixels=s,this.cellWidthInPixels=s,this.cellUnitWidthInPixels=Math.floor(s/this.cellUnitsCount),this.cellUnitHeightInPixels=this.cellUnitWidthInPixels}else this.cellWidthInPixels=Math.floor(this.canvasWidthInPixels/this.colsCountInternal),this.cellHeightInPixels=Math.floor(this.canvasHeightInPixels/this.rowsCountInternal),this.cellUnitWidthInPixels=Math.floor(this.cellWidthInPixels/this.cellUnitsCount),this.cellUnitHeightInPixels=Math.floor(this.cellHeightInPixels/this.cellUnitsCount);this.renderCells()}set colsCount(e){this.colsCountInternal=e,this.calculateDimensions()}set rowsCount(e){this.rowsCountInternal=e,this.calculateDimensions()}get colsCount(){return this.colsCountInternal}get rowsCount(){return this.rowsCountInternal}renderCells(e){if(e&&(this.cells=e),this.keepAspectRatio&&(this.xOffset=Math.round((this.canvasWidthInPixels-this.cellWidthInPixels*this.colsCount)/2),this.yOffset=Math.round((this.canvasHeightInPixels-this.cellHeightInPixels*this.rowsCount)/2)),this.canvas2DContext.fillStyle=this.addHashToColorString(this.settings.GAME_FIELD_BACKGROUND_COLOR),this.renderActualBounds){const e=this.canvasWidthInPixels-2*this.xOffset,t=this.canvasHeightInPixels-2*this.yOffset;this.canvas2DContext.clearRect(this.xOffset,this.yOffset,e,t),this.canvas2DContext.fillRect(this.xOffset,this.yOffset,e,t)}else this.canvas2DContext.clearRect(0,0,this.canvasWidthInPixels,this.canvasHeightInPixels),this.canvas2DContext.fillRect(0,0,this.canvasWidthInPixels,this.canvasHeightInPixels);for(let e=0;e<this.cells.rowsCount;e++)for(let t=0;t<this.cells.colsCount;t++)this.renderSingleCell(t,e,this.cells.getCell(t,e))}addHashToColorString(e){return`#${e}`}renderSingleCell(e,t,s){if(!s)return;const i=this.getYForRow(t),n=this.getXForCol(e),o=this.settings.FIGURE_COLORS[s];this.canvas2DContext.fillStyle=this.addHashToColorString(o),this.canvas2DContext.fillRect(n,i,this.cellWidthInPixels,this.cellHeightInPixels);const l=new r(n,i),a=new r(n+this.cellWidthInPixels,i),h=new r(a.x,i+this.cellHeightInPixels),c=new r(n,h.y),u=new r(n+this.cellUnitWidthInPixels,i+this.cellUnitHeightInPixels),d=new r(n+this.cellWidthInPixels-this.cellUnitWidthInPixels,u.y),g=new r(d.x,i+this.cellHeightInPixels-this.cellUnitWidthInPixels),m=new r(u.x,g.y);this.drawQuadrangle(l,u,m,c,this.addAlphaToWhiteColor(.1)),this.drawQuadrangle(l,u,d,a,this.addAlphaToWhiteColor(.5)),this.drawQuadrangle(a,d,g,h,"rgba(0,0,0, 0.1)"),this.drawQuadrangle(h,g,m,c,"rgba(0,0,0, 0.5)")}flashRows(e){const t=this.getXForCol(0),s=this.getXForCol(this.settings.GAME_FIELD_WIDTH_IN_CELLS),i=s-t,n=this.addHashToColorString(this.settings.GAME_FIELD_BACKGROUND_COLOR);let o=this.addHashToColorString(this.settings.EFFECT_COLOR);4===e.length&&(o=this.addHashToColorString(this.settings.TETRIS_EFFECT_COLOR));let l=10;const a=()=>{const h=1-l/10,c=t+Math.round(h*i);for(let i of e){const e=new r(t,this.getYForRow(i)),l=new r(c,e.y),a=new r(c,e.y+this.cellHeightInPixels),h=new r(t,a.y);this.drawQuadrangle(e,l,a,h,n);const u=new r(c,e.y),d=new r(s,e.y),g=new r(s,a.y),m=new r(c,a.y);this.drawQuadrangle(u,d,g,m,o)}l-=1,l>=0&&setTimeout(a,7)};setTimeout(a,7)}fillRows(){return new Promise(((e,t)=>{let s=0,i=this.cells.rowsCount-1;const r=()=>{if(!this.cells.getCell(s,i)){const e=Math.floor(Math.random()*(this.settings.FIGURE_COLORS.length-1))+1;this.renderSingleCell(s,i,e)}s+=1,s===this.cells.colsCount&&(s=0,i-=1),i>=0?setTimeout(r):e()};setTimeout(r,150)}))}addAlphaToWhiteColor(e=1){return`rgba(255,255,255, ${e})`}drawQuadrangle(e,t,s,i,r){this.canvas2DContext.beginPath(),this.canvas2DContext.moveTo(e.x,e.y),this.canvas2DContext.lineTo(t.x,t.y),this.canvas2DContext.lineTo(s.x,s.y),this.canvas2DContext.lineTo(i.x,i.y),this.canvas2DContext.closePath(),this.canvas2DContext.fillStyle=r,this.canvas2DContext.fill()}getYForRow(e){return this.yOffset+e*this.cellHeightInPixels}getXForCol(e){return this.xOffset+e*this.cellWidthInPixels}}class o{cells;renderer;constructor(...e){1===e.length?this.cells=e[0]:2===e.length&&(this.cells=new i(e[0],e[1]))}setCanvasRenderer(e){this.renderer=e,this.updateRendererDimensions()}updateRendererDimensions(){this.renderer&&this.cells&&(this.renderer.colsCount=this.cells.colsCount,this.renderer.rowsCount=this.cells.rowsCount)}render(){this.renderer&&this.renderer.renderCells(this.cells)}insertFigures(...e){let t=0,s=0;for(let i of e)i.colsCount>t&&(t=i.colsCount),i.rowsCount>s&&(s=i.rowsCount);const r=Math.ceil(Math.sqrt(e.length)),n=Math.ceil(e.length/r);this.cells=new i(r*t+r-1,n*s+n-1);let o=0,l=0,a=0;for(let i=0;i<e.length;i++){const n=e[i];this.cells=this.cells.mergeWithCells(n,o,l),a+=1,o=o+t+1,a===r&&(o=0,a=0,l=l+s+1)}this.updateRendererDimensions(),this.render()}}class l{settings;figures=[];colors;constructor(e){this.settings=t.getSettings(),this.colors=this.settings.FIGURE_COLORS,this.figures.push(new i([[1,1,1,1]])),this.figures.push(new i([[1,0,0],[1,1,1]])),this.figures.push(new i([[0,0,1],[1,1,1]])),this.figures.push(new i([[0,1,0],[1,1,1]])),this.figures.push(new i([[0,1,1],[1,1,0]])),this.figures.push(new i([[1,1,0],[0,1,1]])),this.figures.push(new i([[1,1],[1,1]])),e!==this.settings.GAME_MODES.MEDIUM&&e!==this.settings.GAME_MODES.HARD||(this.figures.push(new i([[1,0],[1,1]])),this.figures.push(new i([[0,1],[1,1]]))),e===this.settings.GAME_MODES.HARD&&(this.figures.push(new i([[1,0,1],[1,1,1]])),this.figures.push(new i([[1,0,0],[1,1,1],[0,0,1]])),this.figures.push(new i([[0,0,1],[1,1,1],[1,0,0]])))}getRandomFigure(){return this.figures[Math.floor(Math.random()*this.figures.length)]}fillFigureWithRandomColor(e){const t=Math.floor(Math.random()*(this.settings.FIGURE_COLORS.length-1))+1;return e.fillWithColorIndex(t),e}generateFigure(){return this.fillFigureWithRandomColor(this.getRandomFigure())}getAvailableFigures(e=!1){let t;if(e){t=[];for(let e of this.figures)t.push(this.fillFigureWithRandomColor(e.getCopy()))}else t=this.figures;return t}}class a{scoreElement;levelElement;linesElement;constructor(e,t,s){this.scoreElement=document.querySelector(e),this.levelElement=document.querySelector(t),this.linesElement=document.querySelector(s)}render(e,t,s){this.scoreElement.textContent=e.toString(),this.levelElement.textContent=t.toString(),this.linesElement.textContent=s.toString()}}class h{callback;interval;timerId;isEnabled=!1;clockHandler(){this.isEnabled?(this.callback(),this.timerId=setTimeout((()=>{this.clockHandler()}),this.interval)):this.isEnabled=!1}start(){this.isEnabled||(setTimeout((()=>{this.clockHandler()}),this.interval),this.isEnabled=!0)}stop(){this.timerId&&clearTimeout(this.timerId),this.isEnabled=!1}continue(){this.isEnabled&&(this.stop(),this.callback(),this.start())}setInterval(e){this.interval=e}setCallback(e){this.callback=e}}class c{clockGeneratror;LEVELS;LINES;nextLevelLines;currentLevelNumber=0;constructor(e){this.clockGeneratror=e,this.LEVELS=t.getSettings().LEVELS,this.LINES=Object.keys(this.LEVELS).map((e=>parseInt(e))).filter((e=>!isNaN(e))).sort((function(e,t){return e-t}));const s=this.getIntervalForLevelNumber(this.currentLevelNumber);this.clockGeneratror.setInterval(s),this.nextLevelLines=this.getLinesForLevelNumber(this.currentLevelNumber+1)}setLevelForLines(e){if(e>=this.nextLevelLines){this.currentLevelNumber+=1;const e=this.getIntervalForLevelNumber(this.currentLevelNumber);this.clockGeneratror.setInterval(e),this.nextLevelLines=this.getLinesForLevelNumber(this.currentLevelNumber+1)}}getLinesForLevelNumber(e){return this.LINES[e]}getIntervalForLevelNumber(e){const t=this.getLinesForLevelNumber(e);return this.LEVELS[t.toString()]}}class u{score;level;lines;constructor(e,t,s){this.score=e,this.level=t,this.lines=s}}class d{gameFieldRenderer;previewRenderer;scoreRenderer;settings;isStarted;figureRandomizer;clockGenerator;levelSwitcher;currentFigure;nextFigure;gameField;currentFigureCol;currentFigureRow;score=0;level=0;lines=0;promiseResolver;constructor(e,s,r){this.gameFieldRenderer=e,this.previewRenderer=s,this.scoreRenderer=r,this.settings=t.getSettings(),this.gameField=new i(this.settings.GAME_FIELD_WIDTH_IN_CELLS,this.settings.GAME_FIELD_HEIGHT_IN_CELLS),this.gameFieldRenderer.colsCount=this.gameField.colsCount,this.gameFieldRenderer.rowsCount=this.gameField.rowsCount,this.previewRenderer.colsCount=4,this.previewRenderer.rowsCount=3,this.clockGenerator=new h,this.clockGenerator.setCallback((()=>{this.handleClock()})),this.levelSwitcher=new c(this.clockGenerator)}start(e){if(!this.isStarted)return this.clockGenerator.start(),this.figureRandomizer=new l(e),this.nextFigure=this.figureRandomizer.generateFigure(),this.previewRenderer.renderCells(this.nextFigure),this.renderScore(),new Promise(((e,t)=>{this.promiseResolver=e}))}drop(){let e,t=0,s=this.currentFigureRow;try{for(;this.currentFigureRow<this.gameField.rowsCount;)e=this.gameField.mergeWithCells(this.currentFigure,this.currentFigureCol,s),t+=1,s+=1}catch(i){this.score+=t,this.currentFigureRow=s-1,this.gameFieldRenderer.renderCells(e)}}rotateClockwise(){try{const e=this.currentFigure.rotateClockwise(),t=this.gameField.mergeWithCells(e,this.currentFigureCol,this.currentFigureRow);this.currentFigure=e,this.gameFieldRenderer.renderCells(t)}catch(e){}}moveRight(){this.moveHorizontal(1)}moveLeft(){this.moveHorizontal(-1)}moveHorizontal(e){try{const t=this.currentFigureCol+e,s=this.gameField.mergeWithCells(this.currentFigure,t,this.currentFigureRow);this.currentFigureCol=t,this.gameFieldRenderer.renderCells(s)}catch(e){}}handleClock(){if(this.currentFigure)try{const e=this.gameField.mergeWithCells(this.currentFigure,this.currentFigureCol,this.currentFigureRow+1);this.gameFieldRenderer.renderCells(e),this.currentFigureRow+=1}catch(e){const t=this.gameField.mergeWithCells(this.currentFigure,this.currentFigureCol,this.currentFigureRow);this.gameField=t,this.currentFigure=void 0,this.handleClock()}else{this.currentFigure=this.nextFigure,this.nextFigure=this.figureRandomizer.generateFigure();try{this.currentFigureCol=this.getInitialColIndex(),this.currentFigureRow=0,this.gameFieldRenderer.renderCells(this.gameField.mergeWithCells(this.currentFigure,this.currentFigureCol,this.currentFigureRow)),this.previewRenderer.renderCells(this.nextFigure)}catch(e){this.handleGameOver()}}this.handleCompleteRows(),this.renderScore()}handleCompleteRows(){const e=[];for(let t=0;t<this.settings.GAME_FIELD_HEIGHT_IN_CELLS;t+=1){let s=!0;for(let e=0;e<this.settings.GAME_FIELD_WIDTH_IN_CELLS;e+=1)if(!this.gameField.getCell(e,t)){s=!1;break}s&&e.push(t)}const t=e.length;this.score+=t*t*10,this.lines+=t,t&&(this.gameFieldRenderer.flashRows(e),this.gameField=this.gameField.removeRows(e),this.levelSwitcher.setLevelForLines(this.lines)),this.level=this.levelSwitcher.currentLevelNumber}renderScore(){this.scoreRenderer.render(this.score,this.level,this.lines)}getInitialColIndex(){return Math.round((this.settings.GAME_FIELD_WIDTH_IN_CELLS-this.currentFigure.colsCount)/2)}handleGameOver(){this.clockGenerator.stop(),this.gameFieldRenderer.fillRows().then((()=>{this.promiseResolver(new u(this.score,this.level,this.lines))}))}}class g{gameMode;gameController;pageElement;promiseResolver;constructor(e){this.gameMode=e,t.getSettings(),this.pageElement=document.querySelector(".game-page");const s=new n(".game-field__canvas",!0,!0),i=new n(".game-sidebar__next-figure__canvas",!0),r=new a(".game-sidebar__score__value",".game-sidebar__level__value",".game-sidebar__lines__value");this.gameController=new d(s,i,r),document.addEventListener("keydown",(e=>{this.handleKeyPressed(e)})),this.gameController.start(e).then((e=>{this.promiseResolver?this.promiseResolver(e):document.dispatchEvent(new Event("gameFinished"))}))}show(){return this.pageElement.style.display="flex",new Promise(((e,t)=>{this.promiseResolver=e}))}hide(){this.pageElement.style.display="none"}handleKeyPressed(e){e.repeat||"ArrowUp"===e.key&&this.gameController.rotateClockwise(),"ArrowDown"===e.key?this.gameController.drop():"ArrowRight"===e.key?this.gameController.moveRight():"ArrowLeft"===e.key&&this.gameController.moveLeft()}}class m{pageElement;constructor(e,t){this.pageElement=document.querySelector(".score-page");document.querySelector(".score-page__header__mode").textContent=t;const s=document.querySelector(".score-page__result__body__score"),i=document.querySelector(".score-page__result__body__level"),r=document.querySelector(".score-page__result__body__lines"),n=document.querySelector(".score-page__best_result__body__score"),o=document.querySelector(".score-page__best_result__body__level"),l=document.querySelector(".score-page__best_result__body__lines"),a=document.querySelector(".score-page__restart__button"),h=e.score;s.textContent=h.toString(),i.textContent=e.level.toString(),r.textContent=e.lines.toString();let c=0,u=0,d=0;const g=`best_score_${t}`,m=localStorage.getItem(g);if(m){const e=JSON.parse(m);c=e.score,d=e.lines,u=e.level}n.textContent=c.toString(),l.textContent=d.toString(),o.textContent=u.toString(),h>c&&this.saveScore(e,g),a.addEventListener("click",(()=>{location.reload()}))}saveScore(e,t){const s=JSON.stringify(e);localStorage.setItem(t,s)}show(){this.pageElement.style.display="block"}hide(){this.pageElement.style.display="none"}}const p=new class{settings;pageElement;gameModeSelectElement;figureRandomizer;figurePreviewController;canvasRenderer;selectedGameModeValue;promiseResolver;constructor(){this.settings=t.getSettings(),this.pageElement=document.querySelector(".settings-page");const e=this.pageElement.querySelector(".settings-form");this.gameModeSelectElement=this.pageElement.querySelector(".settings-form__game-mode-select"),this.pageElement.querySelector(".settings-form__submit-button"),this.canvasRenderer=new n(".figures-preview__canvas",!0);for(let e of Object.entries(this.settings.GAME_MODES)){const t=document.createElement("option");t.text=e[1],t.value=e[0],this.gameModeSelectElement.options.add(t)}this.gameModeSelectElement.options.length>0&&(this.gameModeSelectElement.options[0].selected=!0),e.addEventListener("submit",(e=>{this.handleSettingsFormSubmit(e)})),this.gameModeSelectElement.addEventListener("change",(()=>{this.handleGameModeChanged()})),this.handleGameModeChanged()}show(){return this.pageElement.style.display="block",new Promise(((e,t)=>{this.promiseResolver=e}))}hide(){this.pageElement.style.display="none"}handleSettingsFormSubmit(e){if(e.preventDefault(),this.promiseResolver)this.promiseResolver(this.selectedGameModeValue);else{const e=new Event("gameStarted");document.dispatchEvent(e)}}handleGameModeChanged(){const e=this.gameModeSelectElement.selectedOptions[0].value;this.selectedGameModeValue=this.settings.GAME_MODES[e],this.figureRandomizer=new l(this.selectedGameModeValue),this.figurePreviewController=new o,this.figurePreviewController.setCanvasRenderer(this.canvasRenderer),this.figurePreviewController.insertFigures(...this.figureRandomizer.getAvailableFigures(!0))}};p.show().then((e=>{p.hide();const t=new g(e);t.show().then((s=>{t.hide();new m(s,e).show()}))}))}();
